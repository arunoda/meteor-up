{"version":3,"sources":["../src/plugin-api.js"],"names":["utils","resolvePath","PluginAPI","base","filteredArgs","program","_runHooks","handlers","hookName","messagePrefix","hookHandler","localCommand","console","log","_runHookScript","method","_commandErrorHandler","remoteCommand","getConfig","servers","_runPreHooks","name","yellow","hookList","_runPostHooks","commandName","runCommand","Error","potentialPromise","handler","e","process","exit","then","dirname","args","config","settings","sessions","_enabledSessions","split","configPath","join","settingsPath","verbose","runTaskList","getDockerLogs","runSSHCommand","_createSSHOptions","createSSHOptions","contents","readFileSync","getBasePath","meteor","path","toString","regex","RegExp","test","problems","length","red","plural","forEach","problem","app","Object","assign","type","validate","require","code","error","validateConfig","_normalizeConfig","filePath","text","message","newConfig","script","execSync","cwd","stdio","exitCode","nodemiralHistory","Array","modules","_pickSessions","keys","map","plugins","_loadSessions","moduleConfig","moduleName","hasOwnProperty","indexOf","info","auth","username","opts","ssh","sshAgent","env","SSH_AUTH_SOCK","pem","password","existsSync","agent","session","host"],"mappings":"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","file":"plugin-api.js","sourcesContent":["import * as utils from './utils';\r\n\r\nimport { hooks, runRemoteHooks } from './hooks';\r\n\r\nimport chalk from 'chalk';\r\nimport childProcess from 'child_process';\r\nimport { commands } from './commands';\r\nimport configValidator from './validate/index';\r\nimport fs from 'fs';\r\nimport nodemiral from 'nodemiral';\r\nimport parseJson from 'parse-json';\r\nimport path from 'path';\r\nimport { runConfigPreps } from './prepare-config';\r\n\r\nconst { resolvePath } = utils;\r\n\r\nexport default class PluginAPI {\r\n  constructor(base, filteredArgs, program) {\r\n    this.base = program['config'] ? path.dirname(program['config']) : base;\r\n    this.args = filteredArgs;\r\n    this.config = null;\r\n    this.settings = null;\r\n    this.sessions = null;\r\n    this._enabledSessions = program.servers ? program.servers.split(',') : [];\r\n    this.configPath = program['config'] ? resolvePath(program['config']) : path.join(this.base, 'mup.js');\r\n    this.settingsPath = program['settings'];\r\n    this.verbose = program.verbose;\r\n    this.program = program;\r\n\r\n    this.resolvePath = utils.resolvePath;\r\n    this.runTaskList = utils.runTaskList;\r\n    this.getDockerLogs = utils.getDockerLogs;\r\n    this.runSSHCommand = utils.runSSHCommand;\r\n    this._createSSHOptions = utils.createSSHOptions;\r\n  }\r\n\r\n  getArgs() {\r\n    return this.args;\r\n  }\r\n\r\n  getBasePath() {\r\n    return this.base;\r\n  }\r\n\r\n  getVerbose() {\r\n    return this.verbose;\r\n  }\r\n\r\n  getOptions() {\r\n    return this.program;\r\n  }\r\n\r\n  hasMeteorPackage(name) {\r\n    // Check if app is using the package\r\n    try {\r\n      var contents = fs\r\n        .readFileSync(resolvePath(this.getBasePath(), this.getConfig().meteor.path, '.meteor/versions'))\r\n        .toString();\r\n      // Looks for \"package-name@\" in the beginning of a\r\n      // line or at the start of the file\r\n      let regex = new RegExp(`(^|\\\\s)${name}@`, 'm');\r\n      return regex.test(contents);\r\n\r\n    } catch (e) {\r\n      console.log(`Unable to load file ${resolvePath(this.getBasePath(), this.getConfig().meteor.path, '.meteor/versions')}`);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  validateConfig(configPath) {\r\n    let problems = configValidator(this.getConfig());\r\n\r\n    if (problems.length > 0) {\r\n      let red = chalk.red;\r\n      let plural = problems.length > 1 ? 's' : '';\r\n\r\n      console.log(`loaded config from ${configPath}`);\r\n      console.log('');\r\n      console.log(red(`${problems.length} Validation Error${plural}`));\r\n\r\n      problems.forEach(problem => {\r\n        console.log(red(`  - ${problem}`));\r\n      });\r\n\r\n      console.log('');\r\n      console.log(\r\n        'Read the docs and view example configs at'\r\n      );\r\n      console.log('    http://meteor-up.com/docs');\r\n      console.log('');\r\n    }\r\n\r\n    return problems;\r\n  }\r\n  _normalizeConfig(config) {\r\n    if (typeof config !== 'object') {\r\n      return config;\r\n    }\r\n    if (config.meteor && typeof config.app !== 'object') {\r\n      config.app = Object.assign({}, config.meteor);\r\n      config.app.type = 'meteor';\r\n    } else if (typeof config.app === 'object' && !('type' in config.app)) {\r\n      config.app.type = 'meteor';\r\n    }\r\n\r\n    return runConfigPreps(config);\r\n  }\r\n  getConfig(validate = true) {\r\n    if (!this.config) {\r\n      try {\r\n        // eslint-disable-next-line global-require\r\n        this.config = require(this.configPath);\r\n      } catch (e) {\r\n        if (!validate) {\r\n          return {};\r\n        }\r\n        if (e.code === 'MODULE_NOT_FOUND') {\r\n          console.error('\"mup.js\" file not found at');\r\n          console.error(`  ${this.configPath}`);\r\n          console.error('Run \"mup init\" to create it.');\r\n        } else {\r\n          console.error(e);\r\n        }\r\n        process.exit(1);\r\n      }\r\n      if (validate) {\r\n        this.validateConfig(this.configPath);\r\n      }\r\n      this.config = this._normalizeConfig(this.config);\r\n    }\r\n\r\n    return this.config;\r\n  }\r\n\r\n  getSettings() {\r\n    if (!this.settings) {\r\n      let filePath;\r\n      if (this.settingsPath) {\r\n        filePath = resolvePath(this.settingsPath);\r\n      } else {\r\n        filePath = path.join(this.base, 'settings.json');\r\n      }\r\n\r\n      try {\r\n        this.settings = fs.readFileSync(filePath).toString();\r\n      } catch (e) {\r\n        console.log(`Unable to load settings.json at ${filePath}`);\r\n        if (e.code !== 'ENOENT') {\r\n          console.log(e);\r\n        } else {\r\n          [\r\n            'It does not exist.',\r\n            '',\r\n            'You can create the file with \"mup init\" or add the option',\r\n            '\"--settings path/to/settings.json\" to load it from a',\r\n            'different location.'\r\n          ].forEach(text => console.log(text));\r\n        }\r\n        process.exit(1);\r\n      }\r\n      try {\r\n        this.settings = parseJson(this.settings);\r\n      } catch (e) {\r\n        console.log('Error parsing settings file:');\r\n        console.log(e.message);\r\n\r\n        process.exit(1);\r\n      }\r\n    }\r\n\r\n    return this.settings;\r\n  }\r\n\r\n  setConfig(newConfig) {\r\n    this.config = newConfig;\r\n  }\r\n\r\n  _runHookScript(script) {\r\n    try {\r\n      childProcess.execSync(script, {\r\n        cwd: this.getBasePath(),\r\n        stdio: 'inherit'\r\n      });\r\n    } catch (e) {\r\n      // do nothing\r\n    }\r\n  }\r\n  _runHooks = async function(handlers, hookName) {\r\n    const messagePrefix = `> Running hook ${hookName}`;\r\n    for (let hookHandler of handlers) {\r\n      if (hookHandler.localCommand) {\r\n        console.log(`${messagePrefix} \"${hookHandler.localCommand}\"`);\r\n        this._runHookScript(hookHandler.localCommand);\r\n      }\r\n      if (typeof hookHandler.method === 'function') {\r\n        try {\r\n          await hookHandler.method(this, nodemiral);\r\n        } catch (e) {\r\n          this._commandErrorHandler(e);\r\n        }\r\n      }\r\n      if (hookHandler.remoteCommand) {\r\n        console.log(\r\n          `${messagePrefix} remote command \"${hookHandler.remoteCommand}\"`\r\n        );\r\n        await runRemoteHooks(\r\n          this.getConfig().servers,\r\n          hookHandler.remoteCommand\r\n        );\r\n      }\r\n    }\r\n  }\r\n  _runPreHooks = async function(name) {\r\n    let hookName = `pre.${name}`;\r\n\r\n    if (this.program['show-hook-names']) {\r\n      console.log(chalk.yellow(`Hook: ${hookName}`));\r\n    }\r\n\r\n    if (hookName in hooks) {\r\n      let hookList = hooks[hookName];\r\n      await this._runHooks(hookList, name);\r\n    }\r\n  };\r\n  _runPostHooks = async function(commandName) {\r\n    const hookName = `post.${commandName}`;\r\n\r\n    if (this.program['show-hook-names']) {\r\n      console.log(chalk.yellow(`Hook: ${hookName}`));\r\n    }\r\n\r\n    if (hookName in hooks) {\r\n      let hookList = hooks[hookName];\r\n      await this._runHooks(hookList, hookName);\r\n    }\r\n    return;\r\n  };\r\n  _commandErrorHandler(e) {\r\n    process.exitCode = 1;\r\n\r\n    if (e.nodemiralHistory instanceof Array) {\r\n      // Error is from nodemiral when running a task list.\r\n      // Nodemiral should have already displayed the error\r\n      return;\r\n    }\r\n\r\n    console.error(e);\r\n  }\r\n  runCommand = async function(name) {\r\n    if (!name) {\r\n      throw new Error('Command name is required');\r\n    }\r\n\r\n    if (!(name in commands)) {\r\n      throw new Error(`Unknown command name: ${name}`);\r\n    }\r\n    await this._runPreHooks(name);\r\n    let potentialPromise;\r\n    try {\r\n      potentialPromise = commands[name].handler(this, nodemiral);\r\n    } catch (e) {\r\n      this._commandErrorHandler(e);\r\n      process.exit(1);\r\n    }\r\n\r\n    if (potentialPromise && typeof potentialPromise.then === 'function') {\r\n      return potentialPromise.then(() => this._runPostHooks(name));\r\n    }\r\n    return await this._runPostHooks(name);\r\n  };\r\n\r\n  getSessions(modules = []) {\r\n    const sessions = this._pickSessions(modules);\r\n    return Object.keys(sessions).map(name => sessions[name]);\r\n  }\r\n\r\n  _pickSessions(plugins = []) {\r\n    if (!this.sessions) {\r\n      this._loadSessions();\r\n    }\r\n\r\n    const sessions = {};\r\n\r\n    plugins.forEach(moduleName => {\r\n      const moduleConfig = this.getConfig()[moduleName];\r\n      if (!moduleConfig) {\r\n        return;\r\n      }\r\n\r\n      for (var name in moduleConfig.servers) {\r\n        if (!moduleConfig.servers.hasOwnProperty(name)) {\r\n          continue;\r\n        }\r\n\r\n        if (this.sessions[name]) {\r\n          sessions[name] = this.sessions[name];\r\n        }\r\n      }\r\n    });\r\n\r\n    return sessions;\r\n  }\r\n\r\n  _loadSessions() {\r\n    const config = this.getConfig();\r\n    this.sessions = {};\r\n\r\n    // `mup.servers` contains login information for servers\r\n    // Use this information to create nodemiral sessions.\r\n    for (var name in config.servers) {\r\n      if (!config.servers.hasOwnProperty(name)) {\r\n        continue;\r\n      }\r\n\r\n      if (\r\n        this._enabledSessions.length > 0 &&\r\n          this._enabledSessions.indexOf(name) === -1\r\n      ) {\r\n        continue;\r\n      }\r\n\r\n      const info = config.servers[name];\r\n      const auth = {\r\n        username: info.username\r\n      };\r\n      const opts = {\r\n        ssh: {}\r\n      };\r\n\r\n      var sshAgent = process.env.SSH_AUTH_SOCK;\r\n\r\n      if (info.opts) {\r\n        opts.ssh = info.opts;\r\n      }\r\n\r\n      if (info.pem) {\r\n        try {\r\n          auth.pem = fs.readFileSync(resolvePath(info.pem), 'utf8');\r\n        } catch (e) {\r\n          console.error(`Unable to load pem at \"${resolvePath(info.pem)}\"`);\r\n          console.error(`for server \"${name}\"`);\r\n          if (e.code !== 'ENOENT') {\r\n            console.log(e);\r\n          }\r\n          process.exit(1);\r\n        }\r\n      } else if (info.password) {\r\n        auth.password = info.password;\r\n      } else if (sshAgent && fs.existsSync(sshAgent)) {\r\n        opts.ssh.agent = sshAgent;\r\n      } else {\r\n        console.error(\r\n          \"error: server %s doesn't have password, ssh-agent or pem\",\r\n          name\r\n        );\r\n        process.exit(1);\r\n      }\r\n\r\n      const session = nodemiral.session(info.host, auth, opts);\r\n      this.sessions[name] = session;\r\n    }\r\n  }\r\n}\r\n"]}