{"version":3,"sources":["../src/index.js"],"names":["unwantedArgvs","addModuleCommands","builder","module","moduleName","Object","keys","commands","forEach","command","commandName","name","description","commandWrapper","pluginName","then","rawArgv","process","argv","slice","filteredArgv","api","cwd","potentialPromise","runCommand","e","_commandErrorHandler","catch","console","error","preAPI","config","getConfig","plugins","Array","map","plugin","path","configPath","app","hooks","key","program","usage","yellow","version","alias","global","option","requiresArg","string","boolean","strict","epilogue","help","subYargs","showHelp","_","length"],"mappings":"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","file":"index.js","sourcesContent":["import './node-version';\r\nimport './nodemiral';\r\nimport checkUpdates from './updates';\r\nimport modules, { loadPlugins, locatePluginDir } from './load-plugins';\r\nimport { registerHook } from './hooks';\r\nimport pkg from '../package.json';\r\nimport yargs from 'yargs';\r\nimport chalk from 'chalk';\r\nimport MupAPI from './plugin-api';\r\nimport { filterArgv } from './utils';\r\n\r\nconst unwantedArgvs = ['_', '$0', 'settings', 'config', 'verbose', 'show-hook-names', 'help', 'servers'];\r\n\r\nfunction addModuleCommands(builder, module, moduleName) {\r\n  Object.keys(module.commands).forEach(commandName => {\r\n    let command = module.commands[commandName];\r\n    command.builder = command.builder || {};\r\n\r\n    builder.command(\r\n      command.name || commandName,\r\n      command.description,\r\n      command.builder,\r\n      commandWrapper(moduleName, commandName)\r\n    );\r\n  });\r\n}\r\n\r\nfunction commandWrapper(pluginName, commandName) {\r\n  return function() {\r\n    checkUpdates()\r\n      .then(() => {\r\n        const rawArgv = process.argv.slice(2);\r\n        const filteredArgv = filterArgv(rawArgv, yargs.argv, unwantedArgvs);\r\n        const api = new MupAPI(process.cwd(), filteredArgv, yargs.argv);\r\n        let potentialPromise;\r\n\r\n        try {\r\n          potentialPromise = api.runCommand(`${pluginName}.${commandName}`);\r\n        } catch (e) {\r\n          api._commandErrorHandler(e);\r\n        }\r\n\r\n        if (potentialPromise && typeof potentialPromise.then === 'function') {\r\n          potentialPromise.catch(api._commandErrorHandler);\r\n        }\r\n      })\r\n      .catch(e => {\r\n        console.error(e);\r\n      });\r\n  };\r\n}\r\n\r\n// Load config before creating commands\r\nconst preAPI = new MupAPI(process.cwd(), process.argv, yargs.argv);\r\nconst config = preAPI.getConfig(false);\r\n\r\n// Load plugins\r\nif (config.plugins instanceof Array) {\r\n  loadPlugins(\r\n    config.plugins.map(plugin => {\r\n      return {\r\n        name: plugin,\r\n        path: locatePluginDir(plugin, preAPI.configPath, preAPI.app ? preAPI.app.path : '')\r\n      };\r\n    })\r\n  );\r\n}\r\n\r\n// Load hooks\r\nif (config.hooks) {\r\n  Object.keys(config.hooks).forEach(key => {\r\n    registerHook(key, config.hooks[key]);\r\n  });\r\n}\r\n\r\nlet program = yargs\r\n  .usage(`\\nUsage: ${chalk.yellow('mup')} <command> [args]`)\r\n  .version(pkg.version)\r\n  .alias('version', 'V')\r\n  .global('version', false)\r\n  .option('settings', {\r\n    description: 'Path to Meteor settings file',\r\n    requiresArg: true,\r\n    string: true\r\n  })\r\n  .option('config', {\r\n    description: 'Path to mup.js config file',\r\n    requiresArg: true,\r\n    string: true\r\n  })\r\n  .option('servers', {\r\n    description: 'Comma separated list of servers to use',\r\n    requiresArg: true,\r\n    string: true\r\n  })\r\n  .option('verbose', {\r\n    description: 'Print output from build and server scripts',\r\n    boolean: true\r\n  })\r\n  .option('show-hook-names', {\r\n    description: 'Prints names of the available hooks as the command runs',\r\n    boolean: true\r\n  })\r\n  .strict(true)\r\n  .alias('help', 'h')\r\n  .epilogue(\r\n    'For more information, read the docs at http://meteor-up.com/docs.html'\r\n  )\r\n  .help('help');\r\n\r\nObject.keys(modules).forEach(moduleName => {\r\n  if (moduleName !== 'default' && modules[moduleName].commands) {\r\n    yargs.command(\r\n      moduleName,\r\n      modules[moduleName].description,\r\n      subYargs => {\r\n        addModuleCommands(subYargs, modules[moduleName], moduleName);\r\n      },\r\n      () => {\r\n        yargs.showHelp('log');\r\n      }\r\n    );\r\n  } else if (moduleName === 'default') {\r\n    addModuleCommands(yargs, modules[moduleName], moduleName);\r\n  }\r\n});\r\n\r\nprogram = program.argv;\r\n\r\nif (program._.length === 0) {\r\n  yargs.showHelp();\r\n}\r\n"]}