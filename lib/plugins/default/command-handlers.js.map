{"version":3,"sources":["../../../src/plugins/default/command-handlers.js"],"names":["deploy","init","logs","reconfig","restart","setup","start","stop","ssh","validate","log","config","silent","api","mupJs","resolvePath","__dirname","settinsJson","mupJsDst","process","cwd","settingsJsonDst","mupJsExists","existsSync","settingsJsonExist","cp","console","runCommand","then","on","displayNextSteps","code","getConfig","proxy","servers","serverOption","getArgs","Object","keys","join","exitCode","server","sshOptions","_createSSHOptions","conn","shell","err","stream","end","exit","stdin","setRawMode","pipe","stdout","stderr","setWindow","rows","columns","connect","getOptions","JSON","stringify"],"mappings":"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","file":"command-handlers.js","sourcesContent":["import debug from 'debug';\r\nimport fs from 'fs';\r\nimport sh from 'shelljs';\r\nimport { Client } from 'ssh2';\r\n\r\nconst log = debug('mup:module:default');\r\n\r\nsh.config.silent = true;\r\n\r\nexport function deploy() {\r\n  log('exec => mup deploy');\r\n}\r\n\r\nexport function init(api) {\r\n  log('exec => mup init');\r\n\r\n  const mupJs = api.resolvePath(__dirname, 'template/mup.js.sample');\r\n  const settinsJson = api.resolvePath(__dirname, 'template/settings.json');\r\n  const mupJsDst = api.resolvePath(process.cwd(), 'mup.js');\r\n\r\n  const settingsJsonDst = api.resolvePath(process.cwd(), 'settings.json');\r\n  const mupJsExists = fs.existsSync(mupJsDst);\r\n  const settingsJsonExist = fs.existsSync(settingsJsonDst);\r\n\r\n  if (!settingsJsonExist) {\r\n    sh.cp(settinsJson, settingsJsonDst);\r\n    console.log('Created settings.json');\r\n  } else {\r\n    console.log('Skipping creation of settings.json.');\r\n    console.log(`settings.json already exist at ${settingsJsonDst}.`);\r\n  }\r\n\r\n  if (!mupJsExists) {\r\n    sh.cp(mupJs, mupJsDst);\r\n\r\n    console.log('Created mup.js');\r\n    console.log('');\r\n    console.log('Next Steps:');\r\n    console.log('');\r\n    console.log('  Open mup.js and edit the config to meet your needs.');\r\n    console.log('  Required changes have been marked with a TODO comment.');\r\n    console.log('');\r\n    console.log('  Available options can be found in the docs at');\r\n    console.log('    https://github.com/zodern/meteor-up');\r\n    console.log('');\r\n    console.log('  Then, run the command:');\r\n    console.log('    mup setup');\r\n  } else {\r\n    console.log('Skipping creation of mup.js');\r\n    console.log(`mup.js already exists at ${mupJsDst}`);\r\n  }\r\n}\r\n\r\nexport function logs(api) {\r\n  log('exec => mup logs');\r\n  return api.runCommand('meteor.logs');\r\n}\r\n\r\nexport function reconfig(api) {\r\n  log('exec => mup reconfig');\r\n  return api.runCommand('meteor.envconfig').then(() => api.runCommand('meteor.start'));\r\n}\r\n\r\nexport function restart(api) {\r\n  log('exec => mup restart');\r\n  return api.runCommand('meteor.restart');\r\n}\r\n\r\nexport function setup(api) {\r\n  process.on('exit', function displayNextSteps(code) {\r\n    if (code > 0) {\r\n      return;\r\n    }\r\n\r\n    console.log('');\r\n    console.log('Next, you should run:');\r\n    console.log('    mup deploy');\r\n  });\r\n\r\n  log('exec => mup setup');\r\n  const config = api.getConfig();\r\n  return api.runCommand('docker.setup')\r\n    .then(() => {\r\n      if (config.proxy) {\r\n        return api.runCommand('proxy.setup');\r\n      }\r\n    });\r\n}\r\n\r\nexport function start(api) {\r\n  log('exec => mup start');\r\n  return api.runCommand('meteor.start');\r\n}\r\n\r\nexport function stop(api) {\r\n  log('exec => mup stop');\r\n  return api.runCommand('meteor.stop');\r\n}\r\n\r\nexport function ssh(api) {\r\n  const servers = api.getConfig().servers;\r\n  const serverOption = api.getArgs()[1];\r\n\r\n  if (!(serverOption in servers)) {\r\n    console.log('mup ssh <server>');\r\n    console.log('Available servers are:\\n', Object.keys(servers).join('\\n'));\r\n    process.exitCode = 1;\r\n    return;\r\n  }\r\n\r\n  const server = servers[serverOption];\r\n  const sshOptions = api._createSSHOptions(server);\r\n\r\n  var conn = new Client();\r\n  conn.on('ready', function() {\r\n    conn.shell(function(err, stream) {\r\n      if (err) { throw err; }\r\n      stream.on('close', function() {\r\n        conn.end();\r\n        process.exit();\r\n      });\r\n\r\n      process.stdin.setRawMode(true);\r\n      process.stdin.pipe(stream);\r\n\r\n      stream.pipe(process.stdout);\r\n      stream.stderr.pipe(process.stderr);\r\n      stream.setWindow(process.stdout.rows, process.stdout.columns);\r\n\r\n      process.stdout.on('resize', () => {\r\n        stream.setWindow(process.stdout.rows, process.stdout.columns);\r\n      });\r\n    });\r\n  }).connect(sshOptions);\r\n}\r\n\r\nexport function validate(api) {\r\n  // Shows validation errors\r\n  api.getConfig();\r\n\r\n  if (api.getOptions()['show']) {\r\n    console.log(JSON.stringify(api.getConfig(), null, 2));\r\n  }\r\n}\r\n"]}