{"version":3,"sources":["../../../src/plugins/docker/command-handlers.js"],"names":["setup","restart","ps","log","uniqueSessions","api","sessions","getSessions","reduce","prev","curr","map","session","_host","indexOf","push","list","taskList","executeScript","script","resolvePath","__dirname","length","runTaskList","verbose","args","getArgs","shift","cb","execute","join","err","code","logs","console","magenta","blue","stdout"],"mappings":";;;;;QAoBgBA,K,GAAAA,K;QAkBAC,O,GAAAA,O;QAYAC,E,GAAAA,E;;AAlDhB;;;;AACA;;;;AACA;;AACA;;;;;;AAEA,IAAMC,MAAM,qBAAM,mBAAN,CAAZ;;AAEA,SAASC,cAAT,CAAwBC,GAAxB,EAA6B;AAC3B,MAAMC,WAAWD,IAAIE,WAAJ,CAAgB,CAAC,KAAD,EAAQ,OAAR,EAAiB,OAAjB,CAAhB,CAAjB;AACA,SAAOD,SAASE,MAAT,CACL,UAACC,IAAD,EAAOC,IAAP,EAAgB;AACd,QAAID,KAAKE,GAAL,CAAS;AAAA,aAAWC,QAAQC,KAAnB;AAAA,KAAT,EAAmCC,OAAnC,CAA2CJ,KAAKG,KAAhD,MAA2D,CAAC,CAAhE,EAAmE;AACjEJ,WAAKM,IAAL,CAAUL,IAAV;AACD;AACD,WAAOD,IAAP;AACD,GANI,EAOL,EAPK,CAAP;AASD;;AAEM,SAAST,KAAT,CAAeK,GAAf,EAAoB;AACzBF,MAAI,0BAAJ;AACA,MAAMa,OAAO,oBAAUC,QAAV,CAAmB,cAAnB,CAAb;;AAEAD,OAAKE,aAAL,CAAmB,cAAnB,EAAmC;AACjCC,YAAQd,IAAIe,WAAJ,CAAgBC,SAAhB,EAA2B,wBAA3B;AADyB,GAAnC;;AAIA,MAAMf,WAAWF,eAAeC,GAAf,CAAjB;;AAEA,MAAIC,SAASgB,MAAT,KAAoB,CAAxB,EAA2B;AACzB;AACA;AACD;;AAED,SAAOjB,IAAIkB,WAAJ,CAAgBP,IAAhB,EAAsBV,QAAtB,EAAgC,EAAEkB,SAASnB,IAAImB,OAAf,EAAhC,CAAP;AACD;;AAEM,SAASvB,OAAT,CAAiBI,GAAjB,EAAsB;AAC3B,MAAMW,OAAO,oBAAUC,QAAV,CAAmB,uBAAnB,CAAb;;AAEAD,OAAKE,aAAL,CAAmB,gBAAnB,EAAqC;AACnCC,YAAQd,IAAIe,WAAJ,CAAgBC,SAAhB,EAA2B,0BAA3B;AAD2B,GAArC;;AAIA,MAAMf,WAAWF,eAAeC,GAAf,CAAjB;;AAEA,SAAOA,IAAIkB,WAAJ,CAAgBP,IAAhB,EAAsBV,QAAtB,EAAgC,EAAEkB,SAASnB,IAAImB,OAAf,EAAhC,CAAP;AACD;;AAEM,SAAStB,EAAT,CAAYG,GAAZ,EAAiB;AACtB,MAAIoB,OAAOpB,IAAIqB,OAAJ,EAAX;AACAD,OAAKE,KAAL;AACA,mBAAKvB,eAAeC,GAAf,CAAL,EAA0B,UAACO,OAAD,EAAUgB,EAAV,EAAiB;AACzChB,YAAQiB,OAAR,kBAA+BJ,KAAKK,IAAL,CAAU,GAAV,CAA/B,YAAsD,UAACC,GAAD,EAAMC,IAAN,EAAYC,IAAZ,EAAqB;AACzEC,cAAQ/B,GAAR,CAAY,gBAAMgC,OAAN,OAAkBvB,QAAQC,KAA1B,UAAsC,gBAAMuB,IAAN,cAAsBX,KAAKK,IAAL,CAAU,GAAV,CAAtB,CAAlD;AACAI,cAAQ/B,GAAR,CAAY8B,KAAKI,MAAjB;AACAT;AACD,KAJD;AAKD,GAND;AAOD","file":"command-handlers.js","sourcesContent":["import chalk from 'chalk';\r\nimport debug from 'debug';\r\nimport { each } from 'async';\r\nimport nodemiral from 'nodemiral';\r\n\r\nconst log = debug('mup:module:docker');\r\n\r\nfunction uniqueSessions(api) {\r\n  const sessions = api.getSessions(['app', 'mongo', 'proxy']);\r\n  return sessions.reduce(\r\n    (prev, curr) => {\r\n      if (prev.map(session => session._host).indexOf(curr._host) === -1) {\r\n        prev.push(curr);\r\n      }\r\n      return prev;\r\n    },\r\n    []\r\n  );\r\n}\r\n\r\nexport function setup(api) {\r\n  log('exec => mup docker setup');\r\n  const list = nodemiral.taskList('Setup Docker');\r\n\r\n  list.executeScript('Setup Docker', {\r\n    script: api.resolvePath(__dirname, 'assets/docker-setup.sh')\r\n  });\r\n\r\n  const sessions = uniqueSessions(api);\r\n\r\n  if (sessions.length === 0) {\r\n    // There are no servers, so we can skip running the list\r\n    return;\r\n  }\r\n\r\n  return api.runTaskList(list, sessions, { verbose: api.verbose });\r\n}\r\n\r\nexport function restart(api) {\r\n  const list = nodemiral.taskList('Restart Docker Daemon');\r\n\r\n  list.executeScript('Restart Docker', {\r\n    script: api.resolvePath(__dirname, 'assets/docker-restart.sh')\r\n  });\r\n\r\n  const sessions = uniqueSessions(api);\r\n\r\n  return api.runTaskList(list, sessions, { verbose: api.verbose });\r\n}\r\n\r\nexport function ps(api) {\r\n  let args = api.getArgs();\r\n  args.shift();\r\n  each(uniqueSessions(api), (session, cb) => {\r\n    session.execute(`sudo docker ${args.join(' ')} 2>&1`, (err, code, logs) => {\r\n      console.log(chalk.magenta(`[${session._host}]`) + chalk.blue(` docker ${args.join(' ')}`));\r\n      console.log(logs.stdout);\r\n      cb();\r\n    });\r\n  });\r\n}\r\n"]}